name: æž„å»ºå’Œå‘å¸ƒ OneinStack

on:
  push:
    branches: [ main, master ]
    tags: 
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®æ‰§è¡Œæƒé™
      run: |
        echo "è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
        chmod +x install.sh
        chmod +x amz-docker.sh
        chmod +x reset_db_root_password.sh
        chmod +x uninstall.sh
        
        # ä¸ºincludeç›®å½•ä¸‹çš„è„šæœ¬è®¾ç½®æ‰§è¡Œæƒé™
        find include/ -name "*.sh" -type f -exec chmod +x {} \;
        
        echo "æƒé™è®¾ç½®å®Œæˆ"
        ls -la *.sh
        
    - name: éªŒè¯æ–‡ä»¶æƒé™
      run: |
        echo "éªŒè¯ä¸»è¦è„šæœ¬çš„æ‰§è¡Œæƒé™..."
        test -x install.sh && echo "âœ“ install.sh æœ‰æ‰§è¡Œæƒé™" || echo "âœ— install.sh æ— æ‰§è¡Œæƒé™"
        test -x amz-docker.sh && echo "âœ“ amz-docker.sh æœ‰æ‰§è¡Œæƒé™" || echo "âœ— amz-docker.sh æ— æ‰§è¡Œæƒé™"
        test -x reset_db_root_password.sh && echo "âœ“ reset_db_root_password.sh æœ‰æ‰§è¡Œæƒé™" || echo "âœ— reset_db_root_password.sh æ— æ‰§è¡Œæƒé™"
        test -x uninstall.sh && echo "âœ“ uninstall.sh æœ‰æ‰§è¡Œæƒé™" || echo "âœ— uninstall.sh æ— æ‰§è¡Œæƒé™"
        
    - name: åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo "æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" > BUILD_INFO.txt
        echo "Gitæäº¤: ${{ github.sha }}" >> BUILD_INFO.txt
        echo "Gitåˆ†æ”¯: ${{ github.ref_name }}" >> BUILD_INFO.txt
        echo "æž„å»ºå·: ${{ github.run_number }}" >> BUILD_INFO.txt
        cat BUILD_INFO.txt
        
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      run: |
        echo "æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶..."
        # åˆ é™¤gitç›¸å…³æ–‡ä»¶å’Œä¸´æ—¶æ–‡ä»¶
        rm -rf .git
        rm -rf .github
        
        # åˆ é™¤å¯èƒ½å­˜åœ¨çš„ä¸´æ—¶æ–‡ä»¶
        find . -name "*.tmp" -delete
        find . -name "*.log" -delete
        find . -name ".DS_Store" -delete
        
    - name: åˆ›å»ºæ‰“åŒ…ç›®å½•
      run: |
        echo "å‡†å¤‡æ‰“åŒ…ç›®å½•..."
        cd ..
        
        # åˆ›å»ºoneinstackç›®å½•
        mkdir -p oneinstack-package/oneinstack
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°oneinstackç›®å½•
        cp -r oneinstack/* oneinstack-package/oneinstack/
        
        # è¿›å…¥æ‰“åŒ…ç›®å½•
        cd oneinstack-package
        
        echo "æ‰“åŒ…ç›®å½•å†…å®¹:"
        ls -la oneinstack/
        
    - name: åˆ›å»ºtar.gzåŒ…
      run: |
        cd ..
        cd oneinstack-package
        
        # èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          PACKAGE_NAME="oneinstack-${VERSION}"
        else
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          VERSION="$(date +%Y%m%d)-${SHORT_SHA}"
          PACKAGE_NAME="oneinstack-${VERSION}"
        fi
        
        echo "åˆ›å»º ${PACKAGE_NAME}.tar.gz åŒ…..."
        
        # åˆ›å»ºtar.gzåŒ…
        tar -czf "${PACKAGE_NAME}.tar.gz" oneinstack/
        
        # éªŒè¯åŒ…å†…å®¹
        echo "éªŒè¯tar.gzåŒ…å†…å®¹:"
        tar -tzf "${PACKAGE_NAME}.tar.gz" | head -20
        
        # èŽ·å–åŒ…å¤§å°
        PACKAGE_SIZE=$(du -h "${PACKAGE_NAME}.tar.gz" | cut -f1)
        echo "åŒ…å¤§å°: ${PACKAGE_SIZE}"
        
        # ç§»åŠ¨åˆ°æž„å»ºç›®å½•
        mv "${PACKAGE_NAME}.tar.gz" ../oneinstack/
        
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
        echo "PACKAGE_SIZE=${PACKAGE_SIZE}" >> $GITHUB_ENV
        
    - name: æµ‹è¯•è§£åŽ‹
      run: |
        echo "æµ‹è¯•è§£åŽ‹åŠŸèƒ½..."
        
        # åˆ›å»ºæµ‹è¯•ç›®å½•
        mkdir -p test-extract
        cd test-extract
        
        # å¤åˆ¶å¹¶è§£åŽ‹åŒ…
        cp "../${PACKAGE_NAME}.tar.gz" .
        tar -xzf "${PACKAGE_NAME}.tar.gz"
        
        # éªŒè¯è§£åŽ‹ç»“æžœ
        echo "è§£åŽ‹åŽçš„ç›®å½•ç»“æž„:"
        ls -la
        echo ""
        echo "oneinstackç›®å½•å†…å®¹:"
        ls -la oneinstack/
        
        # éªŒè¯ä¸»è¦æ–‡ä»¶å­˜åœ¨ä¸”æœ‰æ‰§è¡Œæƒé™
        echo ""
        echo "éªŒè¯ä¸»è¦è„šæœ¬:"
        test -x oneinstack/install.sh && echo "âœ“ install.sh å­˜åœ¨ä¸”å¯æ‰§è¡Œ" || echo "âœ— install.sh é—®é¢˜"
        test -x oneinstack/amz-docker.sh && echo "âœ“ amz-docker.sh å­˜åœ¨ä¸”å¯æ‰§è¡Œ" || echo "âœ— amz-docker.sh é—®é¢˜"
        test -f oneinstack/options.conf && echo "âœ“ options.conf å­˜åœ¨" || echo "âœ— options.conf ç¼ºå¤±"
        test -d oneinstack/include && echo "âœ“ includeç›®å½•å­˜åœ¨" || echo "âœ— includeç›®å½•ç¼ºå¤±"
        test -d oneinstack/config && echo "âœ“ configç›®å½•å­˜åœ¨" || echo "âœ— configç›®å½•ç¼ºå¤±"
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}
        path: ${{ env.PACKAGE_NAME }}.tar.gz
        retention-days: 30
        
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        cat > RELEASE_NOTES.md << EOF
        # OneinStack ${{ github.ref_name }} å‘å¸ƒ
        
        ## ðŸ“¦ å®‰è£…åŒ…ä¿¡æ¯
        - **æ–‡ä»¶å**: ${PACKAGE_NAME}.tar.gz
        - **æ–‡ä»¶å¤§å°**: ${PACKAGE_SIZE}
        - **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - **Gitæäº¤**: ${{ github.sha }}
        
        ## ðŸš€ ä½¿ç”¨æ–¹æ³•
        
        ### 1. ä¸‹è½½å’Œè§£åŽ‹
        \`\`\`bash
        # ä¸‹è½½è§£åŽ‹åŒ…
        wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${PACKAGE_NAME}.tar.gz
        
        # è§£åŽ‹
        tar -xzf ${PACKAGE_NAME}.tar.gz
        
        # è¿›å…¥ç›®å½•
        cd oneinstack
        \`\`\`
        
        ### 2. è¿è¡Œå®‰è£…è„šæœ¬
        \`\`\`bash
        # æ ‡å‡†å®‰è£…
        sudo bash install.sh
        
        # æˆ–è€…å®‰è£…Docker (Amazon Linux)
        sudo bash amz-docker.sh
        \`\`\`
        
        ## ðŸ“‹ åŒ…å«ç»„ä»¶
        - âœ… LNMP/LAMPçŽ¯å¢ƒå®‰è£…è„šæœ¬
        - âœ… Dockerå®‰è£…è„šæœ¬ (é’ˆå¯¹Amazon Linuxä¼˜åŒ–)
        - âœ… æ•°æ®åº“å¯†ç é‡ç½®å·¥å…·
        - âœ… å®Œæ•´å¸è½½è„šæœ¬
        - âœ… å„ç§åº”ç”¨é…ç½®æ¨¡æ¿
        - âœ… ç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬
        
        ## ðŸ”§ æ–°ç‰¹æ€§
        - ä¼˜åŒ–çš„Dockerå®‰è£…è„šæœ¬ï¼Œå¢žå¼ºé”™è¯¯å¤„ç†
        - æ”¹è¿›çš„ç½‘ç»œè¿žæŽ¥æ£€æŸ¥
        - æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œæ—¥å¿—è¾“å‡º
        
        ---
        **æ³¨æ„**: è¯·ç¡®ä¿åœ¨æ”¯æŒçš„Linuxå‘è¡Œç‰ˆä¸Šè¿è¡Œï¼Œå»ºè®®ä½¿ç”¨CentOS 7+ã€Ubuntu 18.04+æˆ–Amazon Linux 2ã€‚
        EOF
        
    - name: åˆ›å»ºRelease
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.PACKAGE_NAME }}.tar.gz
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æž„å»ºæ€»ç»“
      run: |
        echo ""
        echo "ðŸŽ‰ æž„å»ºå®Œæˆ!"
        echo "ðŸ“¦ åŒ…å: ${PACKAGE_NAME}.tar.gz"
        echo "ðŸ“ å¤§å°: ${PACKAGE_SIZE}"
        echo ""
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "ðŸš€ è¿™æ˜¯ä¸€ä¸ªæ ‡ç­¾æž„å»ºï¼Œå°†è‡ªåŠ¨åˆ›å»ºRelease"
        else
          echo "ðŸ“¥ æž„å»ºäº§ç‰©å·²ä¸Šä¼ ä¸ºArtifactï¼Œå¯åœ¨Actionsé¡µé¢ä¸‹è½½"
        fi
        echo ""
        echo "âœ… è§£åŽ‹åŽç›®å½•ç»“æž„: oneinstack/"
        echo "âœ… ä¸»è¦è„šæœ¬å·²è®¾ç½®æ‰§è¡Œæƒé™"
        echo "âœ… åŒ…å†…å®¹å·²éªŒè¯" 